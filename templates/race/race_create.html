{% extends "main.html" %}
{% load static from staticfiles %}
{% block add_static %}
<!-- Kladr JS       --><script type="text/javascript" src="{% static 'js/kladr/jquery.kladr.min.js' %}"></script>
<!-- Kladr CSS      --><link rel='stylesheet' media="screen" type='text/css' href='{% static 'js/kladr/jquery.kladr.min.css' %}'/>
<! -- Yandex Map    --><script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
{% endblock %}
{% block content %}
<script>
        $(document).ready(function() {
            $('select.select2_powered22').select2({
                //   "language": { "noResults": function(){ return "No Resultsrr Found <a href='#' class='btn btn-danger'>Use it anyway</a>"; }},
                "language": "ru",
                placeholder: "объект не указан",
                allowClear: true,
                ajax: {
                    url: "/objects/api/objects_rest/",
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return {
                            search: params.term, // search term
                            page: params.page
                        };
                    },
                    processResults: function (data) {
                        return {
                            results: $.map(data.results, function (item) {
                                {# console.log("Obj: " + item.name + " Type: " + item.type.pk);#}
                                var object_address = "";
                                var company_name = "";
                                if (item.type.pk == '3') {
                                    object_address = item.address.city + ", " + item.address.street + " " + item.address.app;
                                    company_name = item.company.name;
                                };
                                return {
                                    text: item.name,
                                    id: item.pk,
                                    company_name: company_name,
                                    addres: object_address,
                                    type: item.type.pk
                                }
                            })
                        };
                    },
                },
                escapeMarkup: function (markup) { return markup; }, // let our custom formatter work
                minimumInputLength: 1,
                templateResult: formatResults, // omitted for brevity, see the source of this page
{#                templateSelection: formatRepoSelection // omitted for brevity, see the source of this page#}
            });
        });

    function formatResults (result) {
        if (result.loading) return result.text;
        var markup;
        if (result.type == '3') {
            markup = "<div class='select2_result_wrapper'> \
                        <legend>" + result.text + "</legend><span><b>" + result.company_name + "</b></span><span><i class='icon' icon=''></i>" + result.addres + "</span> \
                      </div>";
        } else if (result.type == '2') {
            markup = "<div class='select2_result_wrapper'> \
                        <legend>" + result.text + "</legend><span><i class='icon' icon=''></i>мобильный объект</span> \
                      </div>";
        } else {
            markup = "<div class='select2_result_wrapper'> \
                        <legend>" + result.text + "</legend><span><i class='icon' icon=''></i>база</span> \
                      </div>";
        };
        return markup;
    }
    function formatRepoSelection (results) {
        return results.name || results.text;
    }

</script>
        {# Breadcrumbs #}
        <div class="breadcrumbs">
            <ul>
                <li><a href="{#% url 'company_list_clients' %#}">Рейсы</a></li>
                <li class="active" ><a href="#">Новый рейс</a></li>
            </ul>
        </div>
        {# - Breadcrumbs #}
        <div class="sheet_wrapper">
            <div class="left_border"><span class="upblock"></span></div>
            {# Рабочий лист #}
            <div class="sheet">
                {# Левый бар - меню карточки  #}
                <div class="left_bar">
                    <ul><li><a href="#" class="active">
                            {% if forms.address.instance %}Основная информация
                            {% else %}Новый объект
                            {% endif %}
                            </a></li></ul><hr>
                </div>
                {# - Левый бар #}
                        {# Форма объекта #}
                <form action="" method="POST" id="new_object">{% csrf_token %}
                    <div class="data_grid_medium">
                            <div class="flex_row">
                                <div class="flex_block _zero">
                                    <div class="form_row"><h2 class="blue">Клиент</h2></div>
                                    <div class="form_row">{% include "form_snippets/textinput.html" with field=form.company  %}</div>
                                </div>
                                <div class="flex_block bordered">
                                    <div class="form_row"><h2 class="blue">Контрагент</h2></div>
                                    <div class="form_row">{% include "form_snippets/textinput.html" with field=form.contragent  %}</div>
                                </div>
                            </div>
                            <div class="form_row">
                                <span class="button_block">
                                    <a class="button"  onclick="$('form#new_object').submit();">Сохранить</a>
                                </span>
                            </div>
                        {# - Форма объекта #}
                        {# ошибки формы #}
                        {% include "form_snippets/form_errors.html" with form=forms.address %}
                        {% include "form_snippets/form_errors.html" with form=forms.object %}
                    </div>
                </form>
            </div>
            {# - Рабочий лист #}
            <div class="right_border"><span class="upblock"></span></div>
        </div>
{% endblock %}